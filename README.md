# Printf

## Инструкции по сборке:

```bash
> nasm -f elf64 -l printf.lst printf.s
```
```bash
> g++ -no-pie main.cpp printf.o -o main
```
```bash
> ./main
```

---
### Характеристики системы:

    Система: Linux (x86-64)
    Ассемблер: NASM
    Компилятор: GCC (для связывания с C)

## Описание проекта
Этот проект представляет собой реализацию функции `printf` из стандартной библиотеки `stdio.h` на языке ассемблера x86-64 с использованием синтаксиса NASM. Проект демонстрирует работу с выводом данных, поддерживая следующие спецификаторы формата:

- `%b` — вывод числа в бинарном формате
- `%c` — вывод символа
- `%d` — вывод целого числа в десятичном формате
- `%o` — вывод числа в восьмеричном формате
- `%s` — вывод строки
- `%t` — пользовательский спецификатор (например, вывод в специальном формате; уточните его назначение)
- `%u` — вывод беззнакового целого числа
- `%x` — вывод числа в шестнадцатеричном формате

Функция разработана с учетом соглашения о вызове ABI (Application Binary Interface) для x86-64, где первые шесть аргументов передаются через регистры, а остальные кладутся в стэк. Затем переводятся в стек для дальнейшей обработки в стиле соглашения `cdecl`. Причиной выбора данного соглашения послужило то, что

---
### Соглашение ABI
- Первые шесть аргументов должны находиться в регистрах
- Оставшиеся аргументы должны помещаться в стек
- Возвращаемое значение должно помещаться в rax

---
### Цели проекта

- Реализовать аналог `printf` на ассемблере, чтобы изучить принцип работы функции стандартной библиотеки.
- Освоить и применить соглашение ABI x86-64 с последующим переходом к управлению аргументами через стек.
- Понять причину наличия уязвимости у стандартной функции printf

---
### Особенности реализации

- **Поддержка спецификаторов**: Каждый спецификатор обрабатывает соответствующий тип данных, преобразуя его в строковый вид.
- **Управление аргументами**: Аргументы, переданные через регистры по ABI, сохраняются на стеке для упрощения доступа.
- **Буферизация**: Вывод формируется в буфере, что оптимизирует работу с данными.

---
### Передача аргументов по ABI

В соответствии с соглашением ABI для x86-64, первые шесть аргументов передаются через регистры:

1. `rdi` — первый аргумент (указатель на форматную строку)
2. `rsi` — второй аргумент
3. `rdx` — третий аргумент
4. `rcx` — четвертый аргумент
5. `r8` — пятый аргумент
6. `r9` — шестой аргумент

Дополнительные аргументы (если их больше шести) передаются через стек.

---
### Перевод первых 6-и аргументов в стек

Для удобства обработки аргументов функция `print`, в нашей реализации, переводит их из регистров в стек. Это делается с помощью следующего фрагмента кода:

```assembly
print:
    push rbp            ; Сохраняем старое значение %rbp
    mov rbp, rsp        ; Устанавливаем новый фрейм стека

    push r9             ; шестой аргумент
    push r8             ; пятый аргумент
    push rcx            ; четвертый аргумент
    push rdx            ; третий аргумент
    push rsi            ; второй аргумент
    push rdi            ; сохраняем первый аргумент
                        ; (форматную строку)
    ;===================;
    ;        ...        ;
    ;===================;
    ;        arg6       ; <---------- Аргументы, переданные через
    ;===================;             стэк вызывающей функцией
    ;    return addr    ; (адрес возврата)
    ;===================;
    ;        %RBP       ; (сохранённое значение %rbp)
    ;===================; <---------- %RBP
    ;        arg5       ; (r9)
    ;===================;
    ;        arg4       ; (r8)
    ;===================;
    ;        arg3       ; (rcx)
    ;===================;
    ;        arg2       ; (rdx)
    ;===================;
    ;        arg1       ; (rsi)
    ;===================;
    ;        arg0       ; (rdi, форматная строка)
    ;===================; <---------- %RSP
```

---
###

### Подробнее:
```
    arg0 — форматная строка (изначально в rdi).
    arg1–arg5 — аргументы, переданные через rsi, rdx, rcx, r8, r9 соответственно.
```